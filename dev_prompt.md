# PWA 销售记账与库存统计应用开发需求

本文档旨在为开发一个用于销售记账与库存统计的 PWA (Progressive Web App) 提供清晰、结构化的需求和指导。

## 一、核心目标

开发一款操作简单、移动端优先、可完全离线运行的轻量级应用，用于小型销售场景下的订单记录、库存跟踪和销售情况统计。

## 二、技术栈建议

为确保开发效率和用户体验，建议采用以下技术栈：

*   **核心框架:** React (使用 Vite 搭建环境)，因其强大的生态和组件化思想。
*   **UI 库:** 采用移动端友好的组件库，如 **Ant Design Mobile** 或 **Material-UI (MUI)**，以快速构建美观且一致的界面。
*   **数据持久化:** 使用 **IndexedDB** 进行客户端数据存储，满足离线运行和较大存储量的需求。推荐使用 `dexie.js` 库来简化 IndexedDB 的操作。
*   **状态管理:** 使用 React Context API 或轻量级状态管理库（如 Zustand）来管理全局状态（如订单、用户信息等）。
*   **PWA 实现:** 通过标准的 Service Worker 配置，实现应用的离线访问和缓存。

## 三、功能需求详述

### 1. 产品管理 (SKU Management)

*   **添加/编辑SKU:**
    *   **基础信息:** SKU 名称、销售价格、文字描述。
    *   **商品图片:** 图片可选。支持通过 **本地文件上传** 或直接 **调用设备相机** 拍照。图片将自动被处理为 `600x600` 像素、`60%` 质量的 JPG 格式，并以 Base64 形式保存在本地。
    *   **子属性:** 支持为每个 SKU **完全自由地** 添加/编辑/删除子属性。子属性以“键-值”对的形式存在（例如：`键: 颜色, 值: 黑色`；`键: 尺码, 值: L`）。一个 SKU 可以有零个或多个子属性。
    *   **唯一性:** 具有不同子属性组合的同一基础产品被视为独立的记录项（例如“T恤-黑-S”和“T恤-黑-M”是两个独立的统计单元）。

### 2. 库存管理 (Inventory Management)

*   **入库:** 创建 SKU 时需设定初始库存数量。
*   **库存查询:** 系统需实时显示每个 SKU（及对应子属性组合）的 `入库数量`、`销售数量` 和 `剩余数量`。
*   **库存调整:** 支持对任意 SKU 的当前库存进行手动增减，并可选择记录调整原因（如“盘点修正”、“损坏”等）。
*   **库存回退:** 已取消（退货）的订单，其包含的 SKU 数量需要自动回退至库存中。

### 3. 订单管理 (Order Management)

*   **创建订单:**
    *   用户可从产品列表中选择 SKU 及其特定的子属性组合，并指定数量，将其添加到当前订单。
    *   **标记赠品:** 在添加产品时，可将其标记为 **赠品**。赠品的价格不计入订单应付总额。
*   **结算订单:**
    *   在结算时，从自定义的支付渠道列表中选择一个进行支付确认。
    *   订单创建后，对应 SKU 的库存将自动扣减。
*   **查看订单:**
    *   提供订单历史列表，可查看每个订单的详情（包含的商品、数量、价格、支付方式、时间等）。
    *   支持按日期、支付渠道等条件对订单进行筛选和搜索。
*   **取消订单 (退货):**
    *   用户可以取消历史订单。取消后，订单状态变为“已取消”，并触发库存回退。

### 4. 支付与统计 (Payment & Analytics)

*   **支付渠道管理:**
    *   支持用户自定义添加或删除支付渠道（例如：微信、支付宝、现金）。
    *   内置一个不可删除的特殊支付渠道—— **“赠送”**。当整笔订单所有商品都是赠品时，使用此渠道结算，订单总额为 0。
*   **销售统计:**
    *   **按 SKU 统计:** 可查看每个 SKU（及子属性组合）的总销售数量。
    *   **按渠道统计:** 统计每个支付渠道（微信、支付宝等）的 `订单总数` 和 `收款总额`。
*   **赠送价值统计:**
    *   需要 **单独统计** 所有作为赠品送出的产品的 **原始价值总和**。这意味着，无论是作为订单内单品赠送，还是通过“赠送”渠道结算的整单赠送，其原始价格都应被累加到“赠送总价值”中进行追踪。

### 5. 数据导出 (Data Export)

*   **导出CSV:** 提供一个“导出全部订单”的选项，点击后能生成并下载一个包含所有订单历史的 CSV 文件。CSV 文件应包含订单号、创建时间、商品名称、属性、数量、单价、是否赠品、订单总额、支付渠道等关键信息。

## 四、数据模型 (Data Models)

*   **Product (SKU):**
    *   `id`: (string) 唯一标识符
    *   `name`: (string) 商品名称
    *   `price`: (number) 单价
    *   `description`: (string) 描述
    *   `image`: (string|null) 经过处理的图片的 Base64 编码字符串
    *   `attributes`: (array) 子属性数组，格式: `[{ key: "颜色", value: "红色" }, { key: "尺码", value: "L" }]`

*   **InventoryItem:**
    *   `id`: (string) 唯一标识符
    *   `productId`: (string) 关联的 Product ID
    *   `attributes`: (object) 描述此库存项的唯一属性组合，例如 `{ "颜色": "红色", "尺码": "L" }`
    *   `stock`: (number) 当前库存数量

*   **Order:**
    *   `id`: (string) 唯一标识符
    *   `items`: (array) 商品列表，格式: `[{ inventoryItemId: "...", quantity: 1, unitPrice: 99, isGift: false }]`
    *   `paymentChannelId`: (string) 支付渠道 ID
    *   `totalAmount`: (number) 订单总金额（赠品价格不计入）
    *   `status`: (string) 订单状态: `completed` | `cancelled`
    *   `createdAt`: (timestamp) 创建时间

*   **PaymentChannel:**
    *   `id`: (string) 唯一标识符
    *   `name`: (string) 渠道名称（如“微信”、“赠送”）
    *   `isSystemChannel`: (boolean) 是否为系统内置渠道（例如“赠送”渠道不可删除）

## 五、界面层级与交互逻辑 (UI Hierarchy & Interaction)

为了提供移动端友好的体验，建议采用底部标签栏 (Bottom Tab Bar) 作为一级导航。

*   **一级导航 (Bottom Tab Bar):**
    1.  **记账 (Sale):** 核心操作页面，用于快速创建订单。
    2.  **库存 (Inventory):** 查看、管理库存，并在此统一管理产品库（增删改SKU）。
    3.  **订单 (Orders):** 浏览历史订单记录。
    4.  **统计 (Stats):** 数据可视化仪表盘。
    5.  **设置 (Settings):** 管理支付渠道与数据导出。

*   **页面交互流程:**
    *   **记账页:**
        *   界面顶部显示当前订单的商品列表和总金额。
        *   页面主体是一个醒目的“添加商品”按钮。点击后，弹出一个模态框或跳转到新页面，展示所有 SKU 列表。
        *   在商品列表中选择一个 SKU 后，如果该 SKU 有子属性，则进一步选择子属性。
        *   确定数量，并提供一个开关 (toggle) 用于“标记为赠品”。
        *   确认后，商品被添加到记账页的订单列表中。
        *   点击“结算”按钮，选择支付方式，完成订单。
    *   **库存页:**
        *   此页面整合了库存查看和产品库管理。
        *   以列表形式展示所有 SKU（及不同属性的）库存项，清晰显示 `名称`、`属性`、`剩余库存`。
        *   页面提供“添加新产品”的入口。
        *   点击任一项，可进入详情页，进行“增加/减少库存”或“编辑产品信息”的操作。
    *   **订单页:**
        *   以列表形式展示所有历史订单，默认按时间倒序排列。
        *   提供搜索和筛选功能（按日期、支付渠道）。
        *   点击订单可查看详情，并找到“取消订单”的按钮。
    *   **统计页:**
        *   使用清晰的列表和卡片展示核心数据：
            *   **关键指标：** 总收入、总订单数等。
            *   **渠道统计：** 以列表形式展示各支付渠道的 `订单笔数` 和 `收款总额`。
            *   **排行统计：** 销售量 Top 5 的商品排行。
            *   **赠送统计：** 赠送产品总价值。
    *   **设置页:**
        *   提供两个功能入口：“支付渠道管理” 和 “数据导出”。
        *   在“支付渠道管理”中，可以添加或删除自定义的支付渠道。
        *   在“数据导出”中，提供导出全部订单为 CSV 文件的功能。